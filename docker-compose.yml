# OwliaBot Docker Compose Configuration
# Usage: docker-compose up -d
#
# Prerequisites:
# 1. Copy config.example.yaml to ./config/app.yaml and configure
# 2. Set environment variables (or use .env file)

services:
  owliabot:
    build:
      context: .
      dockerfile: Dockerfile
    image: owliabot:latest
    container_name: owliabot
    restart: unless-stopped

    # Port mapping for gateway HTTP
    ports:
      - "8787:8787"

    # Volume mounts
    volumes:
      # Config directory - mount your app.yaml and secrets.yaml here
      - ./config:/app/config:ro

      # Workspace directory - bot's working files, memory, etc.
      - ./workspace:/app/workspace

      # Optional: Mount for persistent auth tokens (OAuth credentials)
      - owliabot-data:/home/owliabot/.owliabot

    # Environment variables for secrets
    # Option 1: Set directly (not recommended for production)
    # Option 2: Use .env file (create .env in same directory)
    # Option 3: Use Docker secrets (see production section below)
    environment:
      # AI Provider API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

      # Chat Platform Tokens
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}

      # Gateway HTTP Token (for API authentication)
      - GATEWAY_TOKEN=${GATEWAY_TOKEN:-}

      # Optional: Brave Search API (for web search capability)
      - BRAVE_SEARCH_API_KEY=${BRAVE_SEARCH_API_KEY:-}

      # Timezone (default: UTC)
      - TZ=${TZ:-UTC}

    # Health check using gateway HTTP /health endpoint
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8787/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Named volume for persistent data
volumes:
  owliabot-data:

# ==============================================================================
# Production Configuration Example
# Uncomment and modify for production deployment
# ==============================================================================

# For production with Docker Secrets:
#
# secrets:
#   anthropic_key:
#     file: ./secrets/anthropic_key.txt
#   discord_token:
#     file: ./secrets/discord_token.txt
#   telegram_token:
#     file: ./secrets/telegram_token.txt
#   gateway_token:
#     file: ./secrets/gateway_token.txt
#
# services:
#   owliabot:
#     secrets:
#       - anthropic_key
#       - discord_token
#       - telegram_token
#       - gateway_token
#     environment:
#       - ANTHROPIC_API_KEY_FILE=/run/secrets/anthropic_key
#       - DISCORD_BOT_TOKEN_FILE=/run/secrets/discord_token
#       - TELEGRAM_BOT_TOKEN_FILE=/run/secrets/telegram_token
#       - GATEWAY_TOKEN_FILE=/run/secrets/gateway_token

# ==============================================================================
# Interactive Onboarding
# ==============================================================================

# Run onboarding wizard to generate config interactively:
#
#   docker-compose run --rm -it owliabot-onboard
#
# This creates config in ./owlia_dev/ which is mounted into the main container.

  # owliabot-onboard:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   image: owliabot:latest
  #   container_name: owliabot-onboard
  #   stdin_open: true
  #   tty: true
  #   volumes:
  #     # Onboard writes to ~/.owlia_dev - mount to host for persistence
  #     - ./owlia_dev:/home/owliabot/.owlia_dev
  #     - ./workspace:/app/workspace
  #     - owliabot-data:/home/owliabot/.owliabot
  #   environment:
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
  #     - OPENAI_API_KEY=${OPENAI_API_KEY:-}
  #     - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
  #     - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
  #   command: ["onboard"]

# After onboarding, start the bot with the generated config:
#
#   docker-compose up -d owliabot-from-onboard
#
  # owliabot-from-onboard:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   image: owliabot:latest
  #   container_name: owliabot
  #   restart: unless-stopped
  #   ports:
  #     - "8787:8787"
  #   volumes:
  #     - ./owlia_dev:/home/owliabot/.owlia_dev:ro
  #     - ./workspace:/app/workspace
  #     - owliabot-data:/home/owliabot/.owliabot
  #   environment:
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
  #     - OPENAI_API_KEY=${OPENAI_API_KEY:-}
  #     - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
  #     - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
  #     - GATEWAY_TOKEN=${GATEWAY_TOKEN:-}
  #     - TZ=${TZ:-UTC}
  #   command: ["start", "-c", "/home/owliabot/.owlia_dev/app.yaml"]
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8787/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 10s

# ==============================================================================
# Development Configuration with hot reload
# ==============================================================================

# For development with source mounting:
#
# services:
#   owliabot-dev:
#     build:
#       context: .
#       target: builder  # Use builder stage with dev dependencies
#     volumes:
#       - ./src:/app/src:ro
#       - ./config:/app/config:ro
#       - ./workspace:/app/workspace
#     command: ["npx", "tsx", "watch", "src/entry.ts", "start", "-c", "/app/config/app.yaml"]
#     ports:
#       - "8787:8787"
#     environment:
#       - NODE_ENV=development
