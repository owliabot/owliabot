# Persona Bootstrap

## 1. 概述

Persona 启动（bootstrap）是人设系统的“首次初始化”流程，用于在第一次运行时采集基础人设信息并生成每个 agent 的 overlay 文件。之后启动时，persona 加载器会按层级加载 base 与 overlay，并合并成最终的人设配置，作为系统提示的一部分。

关键点：
- bootstrap 只负责生成 `overlay.md`，不会覆盖 base 文件。
- overlay 与 base 合并后形成最终 persona profile。
- 如启用记忆注入，记忆摘要会在 persona 文档加载完成后追加。

## 2. 首次启动流程（Bootstrap）

### 2.1 对话采集问题列表（默认 6 个）

来源：`src/persona/bootstrap/questions.ts` 的 `DEFAULT_BOOTSTRAP_QUESTIONS`。

1. 你希望我如何称呼你或这个角色？
2. 这个角色的目标/职责是什么？
3. 是否有一句话使命或主要目标？（可选）
4. 偏好的风格/语气有哪些？可用逗号或换行分隔。（可选）
5. 有哪些明确的禁区/边界？可用逗号或换行分隔。
6. 有哪些工具偏好或禁用？可用逗号或换行分隔。（可选）

### 2.2 问题到字段的映射关系

| 问题 ID | 提示 | Frontmatter 字段 | 类型 | 必填 |
| --- | --- | --- | --- | --- |
| `name` | 你希望我如何称呼你或这个角色？ | `name` | `string` | 是 |
| `role` | 这个角色的目标/职责是什么？ | `role` | `string` | 是 |
| `mission` | 是否有一句话使命或主要目标？ | `mission` | `string` | 否 |
| `tone` | 偏好的风格/语气有哪些？ | `tone` | `string[]` | 否 |
| `boundaries` | 有哪些明确的禁区/边界？ | `boundaries` | `string[]` | 是 |
| `tools` | 有哪些工具偏好或禁用？ | `tools` | `string[]` | 否 |

### 2.3 文件生成位置和格式

生成逻辑在 `generatePersonaOverlay`：
- 根目录：`rootDir` 默认 `process.cwd()`。
- 人设目录：`personaDir` 默认 `persona`。
- 输出路径：`persona/agents/<agentId>/overlay.md`。

格式：YAML frontmatter + 正文。
- frontmatter 包含 `schema_version`、`id`、`name`、`role`、`mission`、`tone`、`boundaries`、`tools`、`memory_policy`、`notes`，以及额外的 `status`、`created_at`、`updated_at`。
- 正文默认是 `Agent overlay generated by bootstrap.`，可在调用时覆盖。

示例：
```yaml
---
schema_version: "1.0"
id: "main"
name: "Owlia"
role: "Primary agent"
mission: "Help users build and operate owliabot safely."
tone:
  - "supportive"
boundaries:
  - "Never expose secrets"
tools:
  - "functions.shell_command"
status: "draft"
created_at: "2026-02-05T12:00:00.000Z"
updated_at: "2026-02-05T12:00:00.000Z"
---

Agent overlay generated by bootstrap.
```

## 3. 启动加载流程

### 3.1 文件加载顺序（base → overlay）

来源：`PersonaLoader`。

1. `persona/base/core.md`
2. `persona/base/style.md`
3. `persona/base/boundary.md`
4. `persona/agents/<agentId>/overlay.md`
5. `persona/agents/<agentId>/notes.md`
6. `persona/session/<sessionId>/mask.md`（可选，高优先级）

### 3.2 合并规则说明

来源：`PersonaMerger`。

- 标量字段采用“后者覆盖前者”。
- 列表字段默认 append + 去重（`do`、`dont`、`boundaries`）。
- `tools` 列表采用交集策略（intersect）。
- `tone` 在合并时作为标量覆盖（不做列表合并）。
- 正文内容按加载顺序追加（`notes.md` 例外）。
- `notes` 会从 frontmatter 的 `notes` 与 `notes.md` 正文合并并去重。

### 3.3 记忆注入时机

来源：`PersonaLoader.loadWithMemory`。

- 在完成 base + overlay 加载后执行。
- 若 `enableMemoryInjection` 为 `true`，会基于 `MemoryFilter` 生成记忆摘要并作为 `memory` 文档追加到末尾。
- 记忆文档位于 persona 文档列表的最后一项，便于在系统提示中作为补充参考。

## 4. 集成指南

### 4.1 如何在 CLI 中触发 bootstrap

当前 CLI 尚未内置 bootstrap 命令，推荐集成方式是在 `src/entry.ts` 中新增命令，例如 `owliabot persona bootstrap`，调用 `BootstrapSession` 逐步采集并写入 `overlay.md`。

示例（CLI 逻辑片段）：
```ts
import { BootstrapSession } from "./persona/bootstrap/index.js";

const session = new BootstrapSession({ agentId: "main", personaDir: "persona" });
let question = session.start();
while (question) {
  const answer = await prompt(question.prompt); // 伪代码：读取用户输入
  question = session.answer(question.id, answer);
}

const result = await session.complete();
console.log(`overlay written: ${result.overlayPath}`);
if (!result.validation.isValid) {
  console.warn("bootstrap validation failed", result.validation);
}
```

### 4.2 如何在代码中使用 `PersonaLoader`

```ts
import { PersonaLoader } from "./persona/loader.js";
import { PersonaMerger } from "./persona/merger.js";

const loader = new PersonaLoader({
  rootDir: process.cwd(),
  personaDir: "persona",
  enableMemoryInjection: true,
});

const docs = await loader.loadWithMemory("main", "memory", { sessionId: "session-123" });
const profile = new PersonaMerger().merge(docs);
```

## 5. 配置选项

这些选项由调用方传入：

- `enableMemoryInjection`：`PersonaLoader` 构造参数，默认 `true`。
- `personaDir`：`PersonaLoader` / `BootstrapSession` / `generatePersonaOverlay` 的目录参数，默认 `persona`。
- `agentId`：
  - bootstrap 时由 `BootstrapSession` 传入。
  - 运行期默认取自 `config.agents.defaultId`（参见 `resolveAgentId`），若未配置则为 `main`。

## 6. 安全注意事项

1. 路径验证
- bootstrap 使用 `assertValidAgentId`，禁止空值、绝对路径、路径穿越和路径分隔符。
- 多 agent 管理时，`AgentPersonaManager` 强制 overlay 目录必须位于 `persona/agents/<agentId>` 下。

2. 敏感内容过滤
- 记忆注入前通过 `MemoryFilter` 过滤：
- 排除敏感标签（如 `token`、`private_key`、`password`）。
- 检测敏感关键词模式并丢弃对应条目。
- 仅允许白名单记忆标签（`preference`、`style`、`boundary`、`tooling`、`context`）。

3. Prompt 注入防护
- 记忆摘要在注入前会去除代码块、标题和列表标记，减少指令嵌入风险。
- persona overlay 的内容仅写入 frontmatter 字段，避免把整段用户输入直接作为系统提示。
- 需要在 prompt 组装层保持“结构化拼接”，不要执行或解释 persona 文档中的指令性文本。
